<!DOCTYPE html>
<html lang="es">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4a69bd">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√°ctica de Voces ‚Äì Worship</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f6fa;
  padding: 20px;
}

.card {
  max-width: 420px;
  background: white;
  margin: auto;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
  position: relative;
}

h2 {
  text-align: center;
  margin-top: 0;
}

label {
  font-weight: bold;
  margin-top: 15px;
  display: block;
}

select, button, input[type=range] {
  width: 100%;
  margin-top: 8px;
}

button {
  padding: 14px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #4a69bd;
  color: white;
  margin-top: 10px;
}

button.secondary {
  background: #dcdde1;
  color: #333;
}

button:disabled,
input:disabled,
select:disabled {
  opacity: 0.5;
}

.controls {
  display: flex;
  gap: 10px;
}

.controls button {
  flex: 1;
}

/* Overlay de carga */
.loading {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 16px;
  font-weight: bold;
  font-size: 18px;
}
</style>
</head>

<body>

<div class="card">
  <div id="loading" class="loading">‚è≥ Cargando audios‚Ä¶</div>

  <h2>üé∂ Pr√°ctica de Voces</h2>

  <label>Canci√≥n</label>
  <select id="songSelect">
    <option value="asi-peleo">As√≠ peleo mis batallas</option>
    <option value="bendito-jesus">Bendito Jes√∫s</option>
    <option value="manda-lluvia">Manda lluvia</option>
    <option value="rey-de-gloria">Rey de gloria</option>
    <option value="hay-libertad">Hay libertad</option>
    <option value="cielo-y-tierra">El cielo y la tierra</option>
    <option value="espiritu-santo">Esp√≠ritu Santo</option>
    <option value="creo-en-ti">Creo en t√≠</option>
    <option value="ya-no-soy-esclavo">Ya no soy esclavo</option>
    <option value="vamos-a-cantar">Vamos a cantar</option>
  </select>

  <button id="playBtn" onclick="play()">‚ñ∂ Play</button>
  <button id="pauseBtn" class="secondary" onclick="pause()">‚è∏ Pause</button>

  <div class="controls">
    <button class="secondary" onclick="seek(-10)">‚è™ -10s</button>
    <button class="secondary" onclick="seek(10)">‚è© +10s</button>
  </div>

  <label>‚è± Progreso</label>
  <input id="progress" type="range" min="0" max="100" value="0">

  <div id="timeDisplay" style="text-align:center; margin-top:6px; font-weight:bold;">
  00:00 / 00:00
  </div>

  <label>üéº Track</label>
  <input type="range" min="0" max="1" step="0.01" value="1"
         oninput="gainTrack.gain.value = this.value">

  <label>üé§ Voz 1</label>
  <input type="range" min="0" max="1" step="0.01" value="1"
         oninput="gainVoz1.gain.value = this.value">

  <label>üé§ Voz 2</label>
  <input type="range" min="0" max="1" step="0.01" value="1"
         oninput="gainVoz2.gain.value = this.value">
</div>

<script>
let audioCtx;
let buffers = {};
let sources = {};
let gainTrack, gainVoz1, gainVoz2;

let startTime = 0;
let pauseTime = 0;
let isPlaying = false;
let duration = 0;
let progressInterval;

const songSelect = document.getElementById('songSelect');
const progress = document.getElementById('progress');
const loading = document.getElementById('loading');
const controls = document.querySelectorAll('button, input, select');

document.body.addEventListener('touchend', async () => {
  if (audioCtx && audioCtx.state === 'suspended') {
    await audioCtx.resume();
  }
}, { once: true });


function formatTime(seconds) {
  const min = Math.floor(seconds / 60);
  const sec = Math.floor(seconds % 60);
  return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function setEnabled(enabled) {
  controls.forEach(el => el.disabled = !enabled);
}

async function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  gainTrack = audioCtx.createGain();
  gainVoz1 = audioCtx.createGain();
  gainVoz2 = audioCtx.createGain();

  gainTrack.connect(audioCtx.destination);
  gainVoz1.connect(audioCtx.destination);
  gainVoz2.connect(audioCtx.destination);

  await loadSong();
}

async function loadBuffer(url) {
  const res = await fetch(url);
  const arrayBuffer = await res.arrayBuffer();
  return await audioCtx.decodeAudioData(arrayBuffer);
}

async function loadSong() {
  setEnabled(false);
  loading.style.display = 'flex';

  const song = songSelect.value;
  const base = `canciones/${song}/`;

  buffers.track = await loadBuffer(base + 'track.mp3');
  buffers.voz1  = await loadBuffer(base + 'voz1.mp3');
  buffers.voz2  = await loadBuffer(base + 'voz2.mp3');

  duration = buffers.track.duration;

  document.getElementById('timeDisplay').innerText = `00:00 / ${formatTime(duration)}`;
  
  progress.max = duration;
  progress.value = 0;
  pauseTime = 0;

  loading.style.display = 'none';
  setEnabled(true);
  isPlaying = false;

}

function createSources(offset = 0) {
  sources.track = audioCtx.createBufferSource();
  sources.voz1  = audioCtx.createBufferSource();
  sources.voz2  = audioCtx.createBufferSource();

  sources.track.buffer = buffers.track;
  sources.voz1.buffer  = buffers.voz1;
  sources.voz2.buffer  = buffers.voz2;

  sources.track.connect(gainTrack);
  sources.voz1.connect(gainVoz1);
  sources.voz2.connect(gainVoz2);

  sources.track.start(0, offset);
  sources.voz1.start(0, offset);
  sources.voz2.start(0, offset);

  startTime = audioCtx.currentTime - offset;
}

async function play() {
  if (!audioCtx) {
    await initAudio();
  }

  // üîë CLAVE PARA SAFARI
  if (audioCtx.state === 'suspended') {
    await audioCtx.resume();
  }

  if (isPlaying) return;

  createSources(pauseTime);
  isPlaying = true;

  progressInterval = setInterval(() => {
  const current = audioCtx.currentTime - startTime;
  const safeCurrent = Math.min(current, duration);

  progress.value = safeCurrent;
  document.getElementById('timeDisplay').innerText =
    `${formatTime(safeCurrent)} / ${formatTime(duration)}`;
  }, 200);
}


function pause() {
  if (!isPlaying) return;

  pauseTime = audioCtx.currentTime - startTime;

  sources.track.stop();
  sources.voz1.stop();
  sources.voz2.stop();

  clearInterval(progressInterval);
  isPlaying = false;
}

function seek(seconds) {
  pause();
  pauseTime = Math.max(0, Math.min(duration, pauseTime + seconds));
  play();
}

progress.addEventListener('input', () => {
  pauseTime = Number(progress.value);

  document.getElementById('timeDisplay').innerText =
    `${formatTime(pauseTime)} / ${formatTime(duration)}`;

  if (isPlaying) {
    pause();
    pauseTime = Number(progress.value);
    play();
  }
});

songSelect.addEventListener('change', async () => {
  if (!audioCtx) return;
  pause();
  await loadSong();
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(() => console.log('Service Worker registrado'))
    .catch(err => console.error('SW error', err));
}

</script>

</body>
</html>
